from flask import Flask, render_template, request, jsonify
from flask_mysqldb import MySQL,MySQLdb #pip install flask-mysqldb https://github.com/alexferl/flask-mysqldb
from flask import Flask, flash, request, redirect, render_template
from werkzeug.utils import secure_filename
import cv2
import numpy as np
import io
from PIL import Image
import base64
from Helpers import *
app = Flask(__name__)
app = Flask(__name__)
app.secret_key = "secret key"         
app.secret_key = "caircocoders-ednalan"
        
app.config['MYSQL_HOST'] = 'localhost'
app.config['MYSQL_USER'] = 'root'
app.config['MYSQL_PASSWORD'] = ''
app.config['MYSQL_DB'] = 'testingdb'
app.config['MYSQL_CURSORCLASS'] = 'DictCursor'
mysql = MySQL(app) 
ALLOWED_EXTENSIONS = set(['png', 'jpg', 'jpeg','jfif'])

def allowed_file(filename):
	return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS
@app.route('/', methods=['POST'])
def upload_image():
	images = []
	for file in request.files.getlist("file[]"):
		print("***************************")
		print("image: ", file)
		if file.filename == '':
			flash('No image selected for uploading')
			return redirect(request.url)
		if file and allowed_file(file.filename):
			filename = secure_filename(file.filename)
			filestr = file.read()
			npimg = np.frombuffer(filestr, np.uint8)
			image = cv2.imdecode(npimg, cv2.IMREAD_UNCHANGED)
			ratio = image.shape[0] / 500.0
			orig = image.copy()
			image = Helpers.resize(image, height = 500)

			gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
			fm = cv2.Laplacian(gray, cv2.CV_64F).var()
			result = "Not Blurry"

			if fm < 700:
				result = "Blurry"

			sharpness_value = "{:.0f}".format(fm)
			message = [result,sharpness_value]

			img = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
			file_object = io.BytesIO()
			img= Image.fromarray(Helpers.resize(img,width=500))
			img.save(file_object, 'PNG')
			base64img = "data:image/png;base64,"+base64.b64encode(file_object.getvalue()).decode('ascii')
			images.append([message,base64img])

	print("images:", len(images))
	return render_template('upload.html', images=images )
	
@app.route('/')
def index1():   
	return render_template("base.html")                          
@app.route('/index')
def index():
    cur = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
    cur.execute("SELECT * FROM employee ORDER BY id ASC")
    employee = cur.fetchall()  
    return render_template('index.html', employee = employee)
@app.route("/ab")
def map():
   return render_template("ab.html")
@app.route("/upload")
def ma():
   return render_template("upload.html")    

@app.route("/ajaxfile",methods=["POST","GET"])
def ajaxfile():
    cur = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
    if request.method == 'POST':
        userid = request.form['userid']
        print(userid)
        cur.execute("SELECT * FROM employee WHERE id = %s", [userid])
        employeelist = cur.fetchall() 
    return jsonify({'htmlresponse': render_template('response.html',employeelist=employeelist)})
if __name__ == "__main__":
    app.run(debug=True)
